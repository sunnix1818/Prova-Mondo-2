<script>
/* ===== BASE ===== */
const canvas=document.getElementById("map");
const ctx=canvas.getContext("2d");
const menu=document.getElementById("menu");
const info=document.getElementById("info");

function resize(){
  canvas.width=innerWidth;
  canvas.height=innerHeight;
}
resize();
addEventListener("resize",resize);

/* ===== PROIEZIONE ===== */
const projection=d3.geoMercator()
  .translate([canvas.width/2,canvas.height/2]);

const path=d3.geoPath(projection,ctx);

/* ===== ZOOM ===== */
let transform=d3.zoomIdentity;
d3.select(canvas).call(
  d3.zoom()
    .scaleExtent([1,10])
    .on("zoom",e=>{
      transform=e.transform;
      draw();
    })
);

/* ===== STATE ===== */
let regions=[];
let hovered=null;
let selected=null;
let mode="";
let playerNation="";
let currentTurn="player";

const game={
  regions:{}
};

/* ===== COLORI OWNER ===== */
const COLORS={
  player:"#2563eb",
  ai:"#dc2626"
};

/* ===== MENU ===== */
function showMapMenu(){
  menu.innerHTML=`
    <h2>Seleziona mappa</h2>
    <button onclick="selectMap('europe')">üá™üá∫ Europa</button>
    <button onclick="selectMap('world')">üåç Mondo</button>
  `;
}
showMapMenu();

function selectMap(m){
  mode=m;
  menu.innerHTML="<h2>Caricamento‚Ä¶</h2>";

  if(mode==="europe"){
    projection.center([15,55]).scale(650);
    loadMap("https://raw.githubusercontent.com/leakyMirror/map-of-europe/master/GeoJSON/europe.geojson");
  }else{
    projection.center([0,20]).scale(280);
    loadMap("https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson");
  }
}

/* ===== LOAD MAP ===== */
function loadMap(url){
  fetch(url).then(r=>r.json()).then(data=>{
    regions=data.features.map(r=>{
      r._name=r.properties.NAME||r.properties.ADMIN||r.properties.name;
      return r;
    });
    showNationMenu();
  });
}

/* ===== SELEZIONE NAZIONE ===== */
function showNationMenu(){
  const nations=[...new Set(regions.map(r=>r._name))].sort();
  menu.innerHTML="<h2>Scegli la nazione</h2>";

  nations.forEach(n=>{
    const b=document.createElement("button");
    b.textContent=n;
    b.onclick=()=>{
      playerNation=n;
      menu.style.display="none";
      info.style.display="block";
      initGame();
    };
    menu.appendChild(b);
  });
}

/* ===== INIT GAME ===== */
function initGame(){
  game.regions={};

  regions.forEach(r=>{
    game.regions[r._name]={
      owner: r._name===playerNation ? "player" : "ai",
      troops: r._name===playerNation ? 5 : 1
    };
  });

  info.innerHTML="Turno: TU";
  draw();
}

/* ===== DRAW ===== */
function draw(){
  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.fillStyle="#1e40af";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  ctx.setTransform(transform.k,0,0,transform.k,transform.x,transform.y);

  regions.forEach(r=>{
    const state=game.regions[r._name];

    ctx.beginPath();
    path(r);
    ctx.fillStyle=COLORS[state.owner];
    ctx.fill();
    ctx.strokeStyle="#000";
    ctx.lineWidth=0.4;
    ctx.stroke();

    const c=path.centroid(r);
    ctx.fillStyle="#fff";
    ctx.font="bold 11px system-ui";
    ctx.textAlign="center";
    ctx.fillText(state.troops,c[0],c[1]);

    if(r===hovered||r===selected){
      ctx.font="bold 13px system-ui";
      ctx.fillText(r._name,c[0],c[1]-14);
    }
  });
}

/* ===== INTERAZIONE ===== */
canvas.addEventListener("mousemove",e=>{
  const x=(e.offsetX-transform.x)/transform.k;
  const y=(e.offsetY-transform.y)/transform.k;
  hovered=null;

  for(let r of regions){
    ctx.beginPath();
    path(r);
    if(ctx.isPointInPath(x,y)){
      hovered=r;
      const s=game.regions[r._name];
      info.innerHTML=`
        <b>${r._name}</b><br>
        Owner: ${s.owner==="player"?"TU":"AI"}<br>
        Truppe: ${s.troops}<br>
        Turno: ${currentTurn==="player"?"TU":"AI"}
      `;
      break;
    }
  }
  draw();
});

canvas.addEventListener("click",()=>{
  if(currentTurn!=="player") return;
  if(hovered && game.regions[hovered._name].owner==="player"){
    selected=hovered;
    draw();
  }
});

/* ===== TURNI ===== */
document.addEventListener("keydown",e=>{
  if(e.key==="Enter" && currentTurn==="player"){
    endTurn();
  }
});

function endTurn(){
  currentTurn="ai";
  reinforce("ai");
  draw();

  setTimeout(()=>{
    reinforce("player");
    currentTurn="player";
    info.innerHTML="Turno: TU";
    draw();
  },700);
}

function reinforce(owner){
  for(let k in game.regions){
    if(game.regions[k].owner===owner){
      game.regions[k].troops++;
    }
  }
}
</script>
