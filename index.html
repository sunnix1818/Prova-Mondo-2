<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Control Europe</title>

<script src="https://d3js.org/d3.v7.min.js"></script>

<style>
html,body{margin:0;padding:0;overflow:hidden;background:#020617;font-family:system-ui}
canvas{display:block}
#ui{
  position:fixed;
  top:10px;left:10px;
  background:rgba(0,0,0,.8);
  color:#fff;
  padding:12px;
  border-radius:10px;
  min-width:240px;
}
button{
  margin-top:6px;
  width:100%;
  background:#2563eb;
  border:none;
  padding:6px;
  color:white;
  border-radius:6px;
  cursor:pointer;
}
</style>
</head>

<body>
<canvas id="map"></canvas>
<div id="ui">
  <div id="info">Caricamentoâ€¦</div>
  <button id="endTurn">Fine turno</button>
</div>

<script>
/* ===== BASE ===== */
const canvas=document.getElementById("map");
const ctx=canvas.getContext("2d");
const info=document.getElementById("info");
const endTurnBtn=document.getElementById("endTurn");

function resize(){
  canvas.width=innerWidth;
  canvas.height=innerHeight;
}
resize();
addEventListener("resize",resize);

/* ===== PROIEZIONE EUROPA ===== */
const projection=d3.geoMercator()
  .center([15,55])
  .scale(650)
  .translate([canvas.width/2,canvas.height/2]);

const path=d3.geoPath(projection,ctx);

/* ===== ZOOM ===== */
let transform=d3.zoomIdentity;
d3.select(canvas).call(
  d3.zoom().scaleExtent([1,8]).on("zoom",e=>{
    transform=e.transform;
    draw();
  })
);

/* ===== GAME STATE ===== */
let regions=[];
let selected=null;
let fromRegion=null;

const players=["Francia","Prussia"];
let currentPlayer=0;

const game={
  regions:{}
};

/* ===== LOAD EUROPA ===== */
fetch("https://raw.githubusercontent.com/leakyMirror/map-of-europe/master/GeoJSON/europe.geojson")
.then(r=>r.json())
.then(data=>{
  regions=data.features;

  regions.forEach(r=>{
    game.regions[r.properties.NAME]={
      owner:players[Math.floor(Math.random()*players.length)],
      troops:Math.floor(Math.random()*3)+1
    };
  });

  draw();
});

/* ===== DRAW ===== */
function draw(){
  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="#1e40af";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  ctx.setTransform(transform.k,0,0,transform.k,transform.x,transform.y);

  regions.forEach(r=>{
    const state=game.regions[r.properties.NAME];

    ctx.beginPath();
    path(r);
    ctx.fillStyle=state.owner==="Francia"?"#2563eb":"#16a34a";
    ctx.fill();
    ctx.strokeStyle="#000";
    ctx.lineWidth=0.6;
    ctx.stroke();

    const c=path.centroid(r);
    ctx.fillStyle="#fff";
    ctx.font="10px system-ui";
    ctx.textAlign="center";
    ctx.fillText(state.troops,c[0],c[1]);

    if(selected===r){
      ctx.strokeStyle="#facc15";
      ctx.lineWidth=2;
      ctx.stroke();
    }
  });
}

/* ===== CLICK ===== */
canvas.addEventListener("click",e=>{
  const x=(e.offsetX-transform.x)/transform.k;
  const y=(e.offsetY-transform.y)/transform.k;

  for(let r of regions){
    ctx.beginPath();
    path(r);
    if(ctx.isPointInPath(x,y)){
      const state=game.regions[r.properties.NAME];

      if(!fromRegion){
        if(state.owner!==players[currentPlayer]) return;
        fromRegion=r;
        selected=r;
      }else{
        attack(fromRegion,r);
        fromRegion=null;
        selected=null;
      }

      info.innerHTML=`
        <b>${r.properties.NAME}</b><br>
        Owner: ${state.owner}<br>
        Truppe: ${state.troops}<br>
        Turno: ${players[currentPlayer]}
      `;
      draw();
      break;
    }
  }
});

/* ===== ATTACCO ===== */
function attack(from,to){
  if(from===to) return;

  const A=game.regions[from.properties.NAME];
  const B=game.regions[to.properties.NAME];

  if(A.owner!==players[currentPlayer]) return;
  if(A.troops<2) return;

  const atk=A.troops-1;
  const def=B.troops;

  if(atk>def){
    B.owner=A.owner;
    B.troops=atk-def;
  }else{
    B.troops-=atk;
  }
  A.troops=1;
}

/* ===== TURNI ===== */
endTurnBtn.onclick=()=>{
  currentPlayer=(currentPlayer+1)%players.length;
  for(let k in game.regions){
    if(game.regions[k].owner===players[currentPlayer]){
      game.regions[k].troops++;
    }
  }
  info.textContent="Turno: "+players[currentPlayer];
  draw();
};
</script>
</body>
</html>
