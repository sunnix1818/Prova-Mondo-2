<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Control ‚Äì Base</title>

<script src="https://d3js.org/d3.v7.min.js"></script>

<style>
html,body{
  margin:0;
  padding:0;
  overflow:hidden;
  background:#020617;
  font-family:system-ui;
}
canvas{display:block}

/* MENU */
#menu{
  position:fixed;
  inset:0;
  background:#020617;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  color:white;
  z-index:10;
}
button{
  width:240px;
  margin:6px;
  padding:10px;
  border:none;
  border-radius:8px;
  background:#2563eb;
  color:white;
  font-size:15px;
  cursor:pointer;
}

/* INFO */
#info{
  position:fixed;
  bottom:10px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,.75);
  color:white;
  padding:8px 14px;
  border-radius:20px;
  pointer-events:none;
  font-size:14px;
}
</style>
</head>

<body>

<div id="menu"></div>
<canvas id="map"></canvas>
<div id="hud" style="display:none"></div>
<div id="info" style="display:none"></div>

<script>
/* ===== BASE ===== */
const canvas=document.getElementById("map");
const ctx=canvas.getContext("2d");
const menu=document.getElementById("menu");
const info=document.getElementById("info");

const hud=document.getElementById("hud");

function resize(){
  canvas.width=innerWidth;
  canvas.height=innerHeight;
}
resize();
addEventListener("resize",resize);

/* ===== PROIEZIONE ===== */
const projection=d3.geoMercator()
  .translate([canvas.width/2,canvas.height/2]);

const path=d3.geoPath(projection,ctx);

/* ===== ZOOM ===== */
let transform=d3.zoomIdentity;
d3.select(canvas).call(
  d3.zoom().scaleExtent([1,10]).on("zoom",e=>{
    transform=e.transform;
    draw();
  })
);

/* ===== STATE ===== */
let regions=[];
let hovered=null;
let selected=null;
let mode="";
let playerNation="";
let mapView="normal";
let date={year:1800,month:1};

const nations={};
const game={regions:{}};

/* ===== COLORI ===== */
function hashColor(name){
  let h=0;
  for(let c of name) h=c.charCodeAt(0)+((h<<5)-h);
  return `hsl(${h%360},55%,45%)`;
}

const DIPLO_COLORS={
  player:"#2563eb",
  ally:"#16a34a",
  neutral:"#facc15",
  enemy:"#dc2626"
};

/* ===== MENU MAPPA ===== */
function showMapMenu(){
  menu.innerHTML=`
    <h2>Seleziona mappa</h2>
    <button onclick="selectMap('europe')">üá™üá∫ Europa</button>
    <button onclick="selectMap('world')">üåç Mondo</button>
  `;
}
showMapMenu();

function selectMap(m){
  mode=m;
  menu.innerHTML="<h2>Caricamento‚Ä¶</h2>";

  if(m==="europe"){
    projection.center([15,55]).scale(650);
    loadMap("https://raw.githubusercontent.com/leakyMirror/map-of-europe/master/GeoJSON/europe.geojson");
  }else{
    projection.center([0,20]).scale(280);
    loadMap("https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson");
  }
}

/* ===== LOAD ===== */
function loadMap(url){
  fetch(url).then(r=>r.json()).then(data=>{
    regions=data.features.map(r=>{
      r._name=r.properties.NAME||r.properties.ADMIN||r.properties.name;
      return r;
    });
    buildNations();
    showNationMenu();
  });
}

/* ===== NAZIONI ===== */
function buildNations(){
  regions.forEach(r=>{
    if(!nations[r._name]){
      nations[r._name]={
        name:r._name,
        color:hashColor(r._name),
        flag:"üè≥Ô∏è",
        money:100,
        population:Math.floor(Math.random()*10+5)*1_000_000,
        troops:5,
        tech:1,
        diplomacy:{}
      };
    }
  });
}

/* ===== SELEZIONE NAZIONE ===== */
function showNationMenu(){
  menu.innerHTML="<h2>Scegli la tua nazione</h2>";
  Object.values(nations).forEach(n=>{
    const b=document.createElement("button");
    b.textContent=n.name;
    b.onclick=()=>{
      playerNation=n.name;
      initGame();
      menu.style.display="none";
      hud.style.display="block";
      draw();
    };
    menu.appendChild(b);
  });
}

/* ===== INIT GAME ===== */
function initGame(){
  Object.values(nations).forEach(n=>{
    n.diplomacy[playerNation]= n.name===playerNation ? "player" : "neutral";
  });

  regions.forEach(r=>{
    game.regions[r._name]={ owner:r._name };
  });

  buildHUD();
}

/* ===== HUD ===== */
function buildHUD(){
  const n=nations[playerNation];
  hud.innerHTML=`
    <div style="position:fixed;inset:0;background:#020617cc;color:white;padding:20px">
      <h1>${n.flag} ${n.name}</h1>
      <p>üìÖ ${date.year}-${String(date.month).padStart(2,"0")}</p>
      <p>üí∞ Soldi: ${n.money}</p>
      <p>üë• Popolazione: ${n.population.toLocaleString()}</p>
      <p>‚öîÔ∏è Truppe: ${n.troops}</p>
      <p>üß™ Tecnologia: ${n.tech}</p>

      <select onchange="mapView=this.value">
        <option value="normal">Vista normale</option>
        <option value="diplomacy">Vista diplomatica</option>
      </select>

      <br><br>
      <button onclick="nextTurn()">Avanza turno</button>
    </div>
  `;
}

/* ===== DRAW ===== */
function draw(){
  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="#1e40af";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  ctx.setTransform(transform.k,0,0,transform.k,transform.x,transform.y);

  regions.forEach(r=>{
    const nation=nations[r._name];
    let color=nation.color;

    if(mapView==="diplomacy"){
      const d=nation.diplomacy[playerNation];
      color=DIPLO_COLORS[d||"neutral"];
    }

    ctx.beginPath();
    path(r);
    ctx.fillStyle=color;
    ctx.fill();
    ctx.strokeStyle="#000";
    ctx.lineWidth=0.4;
    ctx.stroke();

    if(r===hovered||r===selected){
      const c=path.centroid(r);
      ctx.fillStyle="#fff";
      ctx.font="bold 13px system-ui";
      ctx.textAlign="center";
      ctx.fillText(r._name,c[0],c[1]);
    }
  });
}

/* ===== INTERAZIONE ===== */
canvas.addEventListener("mousemove",e=>{
  const x=(e.offsetX-transform.x)/transform.k;
  const y=(e.offsetY-transform.y)/transform.k;
  hovered=null;

  for(let r of regions){
    ctx.beginPath();
    path(r);
    if(ctx.isPointInPath(x,y)){
      hovered=r;
      info.textContent=r._name;
      break;
    }
  }
  draw();
});

canvas.addEventListener("click",()=>{
  selected=hovered;
  draw();
});

/* ===== TURNI ===== */
function nextTurn(){
  date.month++;
  if(date.month>12){
    date.month=1;
    date.year++;
  }

  const n=nations[playerNation];
  n.money+=10;
  n.tech+=0.1;

  buildHUD();
  draw();
}
</script>
</body>
</html>
